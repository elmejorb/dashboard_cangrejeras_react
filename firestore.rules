rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== FUNCIONES HELPER =====
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role in ['Admin', 'Super Admin'];
    }

    function isSuperAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'Super Admin';
    }

    function isFanUser() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ===== ADMINISTRADORES (Dashboard CMS) =====
    match /admins/{adminId} {
      // Solo admins pueden leer otros perfiles
      allow read: if isAdmin() || isOwner(adminId);

      // Solo pueden actualizar su propio perfil (excepto rol y permisos)
      allow update: if isOwner(adminId) &&
                      !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['role', 'permissions', 'email']);

      // Solo Super Admins pueden crear/eliminar/modificar roles
      allow create, delete: if isSuperAdmin();
      allow update: if isSuperAdmin();
    }

    // ===== USUARIOS DE LA APP (Fans) =====
    match /users/{userId} {
      // Cualquier usuario autenticado puede leer perfiles de fans
      allow read: if isAuthenticated();

      // Los fans pueden crear y actualizar su propio perfil
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) &&
                      !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['votesCount']);

      // Solo admins pueden eliminar usuarios
      allow delete: if isAdmin();

      // Admins pueden leer/actualizar todos los usuarios
      allow read, update: if isAdmin();
    }

    // ===== JUGADORAS =====
    match /players/{playerId} {
      // Todos pueden leer (incluso sin autenticar para la app pública)
      allow read: if true;

      // Solo admins pueden crear/modificar/eliminar
      allow create, update, delete: if isAdmin();
    }

    // ===== PARTIDOS =====
    match /matches/{matchId} {
      // Todos pueden leer
      allow read: if true;

      // Solo admins pueden crear/modificar/eliminar
      allow create, update, delete: if isAdmin();
    }

    // ===== VOTACIONES =====
    match /votings/{votingId} {
      // Todos pueden leer votaciones
      allow read: if true;

      // Solo admins pueden crear/modificar/eliminar votaciones
      allow create, update, delete: if isAdmin();

      // SUB-COLECCIÓN: VOTOS
      match /votes/{voteId} {
        // Usuarios autenticados pueden leer votos
        allow read: if isAuthenticated();

        // Solo pueden votar usuarios autenticados (1 voto por usuario por votación)
        // El voteId debe ser igual al userId para garantizar 1 voto por usuario
        allow create: if isAuthenticated() &&
                        voteId == request.auth.uid &&
                        request.resource.data.userId == request.auth.uid &&
                        // La votación debe estar activa
                        get(/databases/$(database)/documents/votings/$(votingId)).data.status == 'active';

        // No se pueden modificar ni eliminar votos una vez emitidos
        allow update, delete: if false;

        // Admins pueden ver todos los votos
        allow read: if isAdmin();
      }
    }

    // ===== NOTICIAS =====
    match /news/{newsId} {
      // Todos pueden leer noticias publicadas
      allow read: if resource.data.status == 'published';

      // Admins y editores pueden ver borradores propios
      allow read: if isAuthenticated() &&
                    (isAdmin() || resource.data.author == request.auth.uid);

      // Admins y editores pueden crear noticias
      allow create: if isAdmin() ||
                      (isAuthenticated() &&
                       exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'Editor');

      // Solo el autor o admins pueden modificar
      allow update: if isAdmin() ||
                      (isAuthenticated() && resource.data.author == request.auth.uid);

      // Solo Super Admins pueden eliminar
      allow delete: if isSuperAdmin();
    }

    // ===== EQUIPOS =====
    match /teams/{teamId} {
      // Todos pueden leer (para autocompletar en formularios)
      allow read: if true;

      // Solo admins pueden crear/modificar/eliminar equipos
      allow create, update, delete: if isAdmin();
    }

    // ===== ESTADIOS/VENUES =====
    match /venues/{venueId} {
      // Todos pueden leer (para autocompletar en formularios)
      allow read: if true;

      // Solo admins pueden crear/modificar/eliminar venues
      allow create, update, delete: if isAdmin();
    }

    // ===== PLANTILLAS DE VOTACIÓN =====
    match /voting_templates/{templateId} {
      // Admins autenticados pueden leer plantillas
      allow read: if isAuthenticated();

      // Solo admins pueden crear/modificar/eliminar plantillas
      allow create, update, delete: if isAdmin();
    }

    // ===== POLLS (Votaciones Activas) =====
    match /polls/{pollId} {
      // Todos pueden leer polls (incluso fans en la app)
      allow read: if true;

      // Solo admins pueden crear/modificar/eliminar
      allow create, update, delete: if isAdmin();

      // SUB-COLECCIÓN: VOTOS EN POLLS
      match /votes/{voteId} {
        // Usuarios autenticados pueden leer votos
        allow read: if isAuthenticated();

        // Usuarios autenticados pueden votar
        allow create: if isAuthenticated() &&
                        voteId == request.auth.uid &&
                        request.resource.data.userId == request.auth.uid;

        // No se pueden modificar ni eliminar votos
        allow update, delete: if false;

        // Admins pueden ver todos los votos
        allow read: if isAdmin();
      }
    }

    // ===== LIVE POLLS (Votaciones en Vivo) =====
    match /live_polls/{pollId} {
      // Todos pueden leer votaciones en vivo (incluso fans en la app)
      allow read: if true;

      // Solo admins pueden crear/eliminar
      allow create, delete: if isAdmin();

      // Admins pueden actualizar cualquier campo
      allow update: if isAdmin();

      // Usuarios autenticados pueden actualizar SOLO los contadores de votos
      // cuando están votando: options (con votes/percentage) y totalVotes
      // NO pueden modificar: title, description, isActive, matchId, etc.
      allow update: if isAuthenticated() &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['options', 'totalVotes']) &&
                      request.resource.data.title == resource.data.title &&
                      request.resource.data.isActive == resource.data.isActive &&
                      request.resource.data.matchId == resource.data.matchId;

      // SUB-COLECCIÓN: VOTOS EN LIVE POLLS (no se usa actualmente)
      match /votes/{voteId} {
        // Usuarios autenticados pueden leer votos
        allow read: if isAuthenticated();

        // Usuarios autenticados pueden votar
        allow create: if isAuthenticated() &&
                        voteId == request.auth.uid &&
                        request.resource.data.userId == request.auth.uid;

        // No se pueden modificar ni eliminar votos
        allow update, delete: if false;

        // Admins pueden ver todos los votos
        allow read: if isAdmin();
      }
    }

    // ===== TABLA DE POSICIONES =====
    match /standings/{standingId} {
      // Todos pueden leer la tabla de posiciones
      allow read: if true;

      // Solo admins pueden crear/modificar/eliminar
      allow create, update, delete: if isAdmin();
    }

    // ===== REGISTRO DE ACTIVIDAD =====
    match /activityLog/{logId} {
      // Solo admins pueden leer el log de actividad
      allow read: if isAdmin();

      // Cualquier usuario autenticado puede escribir en el log (se valida en el código)
      allow create: if isAuthenticated();

      // No se puede modificar ni eliminar el historial
      allow update, delete: if false;
    }

    // ===== ESTADÍSTICAS =====
    match /stats/{document=**} {
      // Todos pueden leer estadísticas
      allow read: if true;

      // Solo admins pueden actualizar
      allow write: if isAdmin();
    }

    // ===== VOTOS (Colección principal para live_polls) =====
    match /votes/{voteId} {
      // Usuarios autenticados pueden leer sus propios votos
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Admins pueden leer todos los votos
      allow read: if isAdmin();

      // Usuarios autenticados pueden crear votos
      // Validaciones:
      // - Solo pueden votar una vez por partido (validado en código)
      // - El voto debe tener su userId
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      // No se pueden modificar ni eliminar votos una vez emitidos
      allow update, delete: if false;
    }

    // ===== DENEGAR TODO LO DEMÁS =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
